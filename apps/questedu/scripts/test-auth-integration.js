#!/usr/bin/env node

/**
 * Firebase Authentication Integration Test
 * 
 * This script validates the Firebase authentication setup for the QuestEdu mobile app.
 * It checks for proper configuration, file structure, and basic functionality.
 */

const { existsSync, readFileSync } = require('fs');
const { join } = require('path');

class AuthIntegrationTester {
  constructor() {
    this.results = {
      firebaseConfig: false,
      authContext: false,
      authScreens: false,
      authGuard: false,
      routeIntegration: false,
      drawerIntegration: false
    };
  }

  testFirebaseConfiguration() {
    console.log('üî• Testing Firebase Configuration...');
    
    const configFile = 'firebase-config.ts';
    
    if (existsSync(configFile)) {
      const content = readFileSync(configFile, 'utf8');
      
      const hasAuth = content.includes('getFirebaseAuth');
      const hasFirestore = content.includes('getFirestoreDb');
      const hasConfig = content.includes('firebaseConfig');
      
      console.log(`   ${hasAuth ? '‚úÖ' : '‚ùå'} Firebase Auth export`);
      console.log(`   ${hasFirestore ? '‚úÖ' : '‚ùå'} Firestore export`);
      console.log(`   ${hasConfig ? '‚úÖ' : '‚ùå'} Firebase config`);
      
      this.results.firebaseConfig = hasAuth && hasFirestore && hasConfig;
    } else {
      console.log('   ‚ùå firebase-config.ts not found');
    }
    
    console.log('');
  }

  testAuthContext() {
    console.log('üîê Testing Auth Context...');
    
    const contextFile = 'contexts/AuthContext.tsx';
    
    if (existsSync(contextFile)) {
      const content = readFileSync(contextFile, 'utf8');
      
      const hasProvider = content.includes('AuthProvider');
      const hasContext = content.includes('useAuth');
      const hasSignIn = content.includes('signIn');
      const hasSignUp = content.includes('signUp');
      const hasSignOut = content.includes('signOut');
      const hasStudentRole = content.includes('STUDENT');
      
      console.log(`   ${hasProvider ? '‚úÖ' : '‚ùå'} AuthProvider component`);
      console.log(`   ${hasContext ? '‚úÖ' : '‚ùå'} useAuth hook`);
      console.log(`   ${hasSignIn ? '‚úÖ' : '‚ùå'} Sign in functionality`);
      console.log(`   ${hasSignUp ? '‚úÖ' : '‚ùå'} Sign up functionality`);
      console.log(`   ${hasSignOut ? '‚úÖ' : '‚ùå'} Sign out functionality`);
      console.log(`   ${hasStudentRole ? '‚úÖ' : '‚ùå'} Student role enforcement`);
      
      this.results.authContext = hasProvider && hasContext && hasSignIn && hasSignUp && hasSignOut && hasStudentRole;
    } else {
      console.log('   ‚ùå AuthContext.tsx not found');
    }
    
    console.log('');
  }

  testAuthScreens() {
    console.log('üì± Testing Auth Screens...');
    
    const screens = [
      'components/auth/LoginScreen.tsx',
      'components/auth/SignupScreen.tsx',
      'components/auth/ForgotPasswordScreen.tsx'
    ];
    
    let validScreens = 0;
    
    screens.forEach(screen => {
      if (existsSync(screen)) {
        const content = readFileSync(screen, 'utf8');
        const hasValidation = content.includes('validation') || content.includes('error');
        const hasAuth = content.includes('useAuth');
        const hasNavigation = content.includes('navigation') || content.includes('router');
        
        console.log(`   ‚úÖ ${screen.split('/').pop()}`);
        console.log(`      ${hasValidation ? '‚úÖ' : '‚ùå'} Form validation`);
        console.log(`      ${hasAuth ? '‚úÖ' : '‚ùå'} Auth integration`);
        console.log(`      ${hasNavigation ? '‚úÖ' : '‚ùå'} Navigation`);
        
        if (hasValidation && hasAuth && hasNavigation) {
          validScreens++;
        }
      } else {
        console.log(`   ‚ùå ${screen.split('/').pop()} not found`);
      }
    });
    
    this.results.authScreens = validScreens === screens.length;
    console.log('');
  }

  testAuthGuard() {
    console.log('üõ°Ô∏è  Testing Auth Guard...');
    
    const guardFile = 'components/AuthGuard.tsx';
    
    if (existsSync(guardFile)) {
      const content = readFileSync(guardFile, 'utf8');
      
      const hasAuth = content.includes('useAuth');
      const hasRedirect = content.includes('router') || content.includes('navigation');
      const hasLoading = content.includes('loading');
      const hasRoleCheck = content.includes('role');
      
      console.log(`   ${hasAuth ? '‚úÖ' : '‚ùå'} Auth integration`);
      console.log(`   ${hasRedirect ? '‚úÖ' : '‚ùå'} Redirect functionality`);
      console.log(`   ${hasLoading ? '‚úÖ' : '‚ùå'} Loading state`);
      console.log(`   ${hasRoleCheck ? '‚úÖ' : '‚ùå'} Role-based access`);
      
      this.results.authGuard = hasAuth && hasRedirect && hasLoading && hasRoleCheck;
    } else {
      console.log('   ‚ùå AuthGuard.tsx not found');
    }
    
    console.log('');
  }

  testRouteIntegration() {
    console.log('üó∫Ô∏è  Testing Route Integration...');
    
    const layoutFile = 'app/_layout.tsx';
    const routes = ['app/login.tsx', 'app/signup.tsx', 'app/forgot-password.tsx'];
    
    if (existsSync(layoutFile)) {
      const content = readFileSync(layoutFile, 'utf8');
      
      const hasAuthProvider = content.includes('AuthProvider');
      const hasDrawerScreens = content.includes('Drawer.Screen');
      const hasHiddenRoutes = content.includes('display: \'none\'');
      
      console.log(`   ${hasAuthProvider ? '‚úÖ' : '‚ùå'} AuthProvider in layout`);
      console.log(`   ${hasDrawerScreens ? '‚úÖ' : '‚ùå'} Drawer screen configuration`);
      console.log(`   ${hasHiddenRoutes ? '‚úÖ' : '‚ùå'} Auth routes hidden from drawer`);
      
      let validRoutes = 0;
      routes.forEach(route => {
        if (existsSync(route)) {
          console.log(`   ‚úÖ ${route.split('/').pop()}`);
          validRoutes++;
        } else {
          console.log(`   ‚ùå ${route.split('/').pop()} not found`);
        }
      });
      
      this.results.routeIntegration = hasAuthProvider && hasDrawerScreens && validRoutes === routes.length;
    } else {
      console.log('   ‚ùå _layout.tsx not found');
    }
    
    console.log('');
  }

  testDrawerIntegration() {
    console.log('üìã Testing Drawer Integration...');
    
    const drawerFile = 'components/CustomDrawerContent.tsx';
    
    if (existsSync(drawerFile)) {
      const content = readFileSync(drawerFile, 'utf8');
      
      const hasAuth = content.includes('useAuth');
      const hasConditionalRendering = content.includes('if (!user)');
      const hasSignOut = content.includes('signOut');
      const hasAuthButtons = content.includes('Sign In') && content.includes('Sign Up');
      
      console.log(`   ${hasAuth ? '‚úÖ' : '‚ùå'} Auth integration`);
      console.log(`   ${hasConditionalRendering ? '‚úÖ' : '‚ùå'} Conditional rendering`);
      console.log(`   ${hasSignOut ? '‚úÖ' : '‚ùå'} Sign out functionality`);
      console.log(`   ${hasAuthButtons ? '‚úÖ' : '‚ùå'} Auth buttons for guests`);
      
      this.results.drawerIntegration = hasAuth && hasConditionalRendering && hasSignOut && hasAuthButtons;
    } else {
      console.log('   ‚ùå CustomDrawerContent.tsx not found');
    }
    
    console.log('');
  }

  generateReport() {
    console.log('üìä Auth Integration Test Results');
    console.log('================================\n');
    
    const tests = [
      { name: 'Firebase Configuration', result: this.results.firebaseConfig },
      { name: 'Auth Context', result: this.results.authContext },
      { name: 'Auth Screens', result: this.results.authScreens },
      { name: 'Auth Guard', result: this.results.authGuard },
      { name: 'Route Integration', result: this.results.routeIntegration },
      { name: 'Drawer Integration', result: this.results.drawerIntegration }
    ];
    
    tests.forEach(test => {
      const status = test.result ? '‚úÖ' : '‚ùå';
      console.log(`${status} ${test.name}`);
    });
    
    const passedTests = tests.filter(test => test.result).length;
    const totalTests = tests.length;
    
    console.log(`\nüìà Overall Score: ${passedTests}/${totalTests} (${Math.round((passedTests/totalTests) * 100)}%)\n`);
    
    if (passedTests === totalTests) {
      console.log('üéâ Congratulations! Firebase authentication is fully integrated and ready to use!');
      console.log('\nüìã What you can now do:');
      console.log('   ‚Ä¢ User registration (student role only)');
      console.log('   ‚Ä¢ User login with email/password');
      console.log('   ‚Ä¢ Password reset functionality');
      console.log('   ‚Ä¢ Route protection with AuthGuard');
      console.log('   ‚Ä¢ Role-based access control');
      console.log('   ‚Ä¢ Profile management');
      console.log('   ‚Ä¢ Authenticated drawer menu');
      console.log('\nüöÄ Next Steps:');
      console.log('   ‚Ä¢ Test the authentication flow in the app');
      console.log('   ‚Ä¢ Add email verification UI');
      console.log('   ‚Ä¢ Implement user profile editing');
      console.log('   ‚Ä¢ Add social login providers');
      console.log('   ‚Ä¢ Set up Firebase security rules');
    } else {
      console.log('‚ö†Ô∏è  Authentication integration is mostly complete, but some areas need attention.');
      console.log('\nüîß To complete setup:');
      
      if (!this.results.firebaseConfig) {
        console.log('   ‚Ä¢ Verify Firebase configuration and exports');
      }
      if (!this.results.authContext) {
        console.log('   ‚Ä¢ Complete AuthContext implementation');
      }
      if (!this.results.authScreens) {
        console.log('   ‚Ä¢ Fix authentication screens');
      }
      if (!this.results.authGuard) {
        console.log('   ‚Ä¢ Implement AuthGuard component');
      }
      if (!this.results.routeIntegration) {
        console.log('   ‚Ä¢ Integrate authentication routes');
      }
      if (!this.results.drawerIntegration) {
        console.log('   ‚Ä¢ Update drawer menu for authentication');
      }
    }
    
    console.log('\nüìö Resources:');
    console.log('   ‚Ä¢ Firebase Auth Documentation: https://firebase.google.com/docs/auth');
    console.log('   ‚Ä¢ React Native Firebase: https://rnfirebase.io/');
    console.log('   ‚Ä¢ Expo Router: https://docs.expo.dev/router/');
  }

  async runAllTests() {
    console.log('üöÄ Firebase Authentication Integration Test');
    console.log('===========================================\n');
    
    this.testFirebaseConfiguration();
    this.testAuthContext();
    this.testAuthScreens();
    this.testAuthGuard();
    this.testRouteIntegration();
    this.testDrawerIntegration();
    
    this.generateReport();
  }
}

// Run the test
if (require.main === module) {
  const tester = new AuthIntegrationTester();
  // Change to the correct directory
  process.chdir(__dirname + '/..');
  
  tester.runAllTests().catch(error => {
    console.error('üí• Auth integration test failed:', error);
    process.exit(1);
  });
}

module.exports = AuthIntegrationTester;
