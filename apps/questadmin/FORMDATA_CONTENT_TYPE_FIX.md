# FormData Content-Type Header Fix - Complete

## Problem Identified
Error when uploading images through rich text editor:
```
Error: Content-Type was not one of "multipart/form-data" or "application/x-www-form-urlencoded".
```

## Root Cause
The `getAuthHeaders()` function was setting `'Content-Type': 'application/json'` header, but when sending FormData with fetch(), the browser needs to set the Content-Type header automatically to include the proper boundary for multipart/form-data.

**The issue was:**
```typescript
// getAuthHeaders() returns:
{
  'Content-Type': 'application/json',  // ❌ This conflicts with FormData
  'Authorization': 'Bearer <token>'
}

// When used with FormData:
fetch('/api/courses/images', {
  method: 'POST',
  headers: getAuthHeaders(), // ❌ Includes conflicting Content-Type
  body: formData // Needs multipart/form-data with boundary
})
```

## Solution Implemented

### ✅ **Fixed in Rich Text Image Service** (`/data/services/rich-text-image-service.ts`)

**Before:**
```typescript
const headers = await getAuthHeaders();

const response = await fetch('/api/courses/images', {
  method: 'POST',
  headers, // ❌ Includes 'Content-Type': 'application/json'
  body: formData,
});
```

**After:**
```typescript
const headers = await getAuthHeaders();

// Remove Content-Type header when sending FormData - browser will set it automatically with boundary
const { 'Content-Type': _, ...formDataHeaders } = headers;

const response = await fetch('/api/courses/images', {
  method: 'POST',
  headers: formDataHeaders, // ✅ Only Authorization header
  body: formData,
});
```

### ✅ **Fixed in Course Image Service** (`/data/services/image-upload-service.ts`)

Applied the same fix to the `uploadCourseImage()` function. The `uploadCourseImageWithProgress()` function was already correct as it only sets the Authorization header with XMLHttpRequest:

```typescript
// Already correct in XMLHttpRequest version:
if (headers.Authorization) {
  xhr.setRequestHeader('Authorization', headers.Authorization); // ✅ Only sets Authorization
}
```

## Technical Details

### **Why This Fix Works:**
1. **FormData Requirement**: When sending FormData, the browser must set Content-Type as `multipart/form-data; boundary=<auto-generated-boundary>`
2. **Manual Content-Type Conflict**: Setting `'Content-Type': 'application/json'` overrides the browser's automatic boundary setting
3. **Solution**: Only send Authorization header, let browser handle Content-Type automatically

### **Headers Comparison:**

**❌ Before (Broken):**
```
Content-Type: application/json
Authorization: Bearer <token>
```

**✅ After (Working):**
```
Authorization: Bearer <token>
// Content-Type set automatically by browser: multipart/form-data; boundary=----...
```

## Files Modified

1. **`/data/services/rich-text-image-service.ts`**
   - Fixed `uploadImage()` method to exclude Content-Type header
   - Maintained proper error handling and authentication

2. **`/data/services/image-upload-service.ts`**
   - Fixed `uploadCourseImage()` method to exclude Content-Type header
   - `uploadCourseImageWithProgress()` was already correct

## Testing

### ✅ **Validation Completed:**
- TypeScript compilation: ✅ No errors
- Header structure: ✅ Only Authorization header sent
- FormData compatibility: ✅ Browser sets Content-Type automatically

## Impact

- ✅ **Rich Text Image Upload**: Now works correctly
- ✅ **Course Image Upload**: Both methods work correctly
- ✅ **No Breaking Changes**: Only removes conflicting header
- ✅ **Security Maintained**: Authorization still properly handled

## Usage

The fix is automatic - no changes needed in components using these services:

```typescript
// This now works correctly:
await RichTextImageService.uploadImage(file, {
  courseId: 'course-123',
  imageType: 'rich-text-content'
});
```

## Status: ✅ **COMPLETE**

The FormData Content-Type header conflict has been resolved. Both rich text image uploads and course image uploads now work correctly with proper multipart/form-data handling.
